
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.21">
    
    
      
        <title>8 triggers - BD - Bases de Datos</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.eebd395e.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#8-triggers" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="BD - Bases de Datos" class="md-header__button md-logo" aria-label="BD - Bases de Datos" data-md-component="logo">
      
  <img src="../../assets/logocaminas.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BD - Bases de Datos
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              8 triggers
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="BD - Bases de Datos" class="md-nav__button md-logo" aria-label="BD - Bases de Datos" data-md-component="logo">
      
  <img src="../../assets/logocaminas.png" alt="logo">

    </a>
    BD - Bases de Datos
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
          Tema 1-Introducció
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Tema 1-Introducció
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T01_Introduccio/objectius/" class="md-nav__link">
        Objectius
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T01_Introduccio/1_fitxers_tradicionals/" class="md-nav__link">
        1. Fitxers tradicionals
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T01_Introduccio/2_concepte_de_base_de_dades/" class="md-nav__link">
        2. Concepte de Base de Dades
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T01_Introduccio/3_caracterstiques_desitjables_dun_sgbd/" class="md-nav__link">
        3. Característiques desitjables d'un SGBD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T01_Introduccio/4_models_de_dades/" class="md-nav__link">
        4. Models de dades
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T01_Introduccio/5_arquitectura_a_3_nivells/" class="md-nav__link">
        5. Arquitectura a 3 nivells
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T01_Introduccio/6_llenguatges_del_sgbd/" class="md-nav__link">
        6. Llenguatges del SGBD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T01_Introduccio/7_classificacions_dels_sgbd/" class="md-nav__link">
        7. Classificacions dels SGBD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T01_Introduccio/autoavaluaci/" class="md-nav__link">
        Autoavaluació
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T02_Model_E-R/" class="md-nav__link">
        Tema 2-Model E/R
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T03_Model_Relacional/" class="md-nav__link">
        Tema 3- Model Relacional
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T04_Normalitzacio/" class="md-nav__link">
        Tema 4- Normalització
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T05_Annex_Base/" class="md-nav__link">
        Tema 5- Annex Base
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T05_Annex_Access/" class="md-nav__link">
        Tema 5- Annex Access
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T06_SQL_I_PostgreSQL/" class="md-nav__link">
        Tema 6- SQL I
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../BD-T06_SQL_II_PostgreSQL/" class="md-nav__link">
        Tema 6- SQL II]
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../(BD-T06_SQL_III_PostgreSQL/index.md" class="md-nav__link">
        Tema 6- SQL III
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../(BD-T07_PLpgSQL/index.md" class="md-nav__link">
        Tema 7- PLpgSQL
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../(BD-T08_BD_NoSQL/index.md)" class="md-nav__link">
        Tema 8- BD NoSQL
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<p>Bases de Dades</p>
<ul>
<li><a href="../">Tema 7: Programació en PostgreSQL</a></li>
<li><a href="../objectius_i_coneixements_previs/">Objectius i Coneixements previs</a></li>
<li><a href="../0_nota_inicial/">0. Nota inicial</a></li>
<li><a href="../1_introducci/">1. Introducció</a></li>
<li><a href="../2_plpgsql/">2. PL/pgSQL</a></li>
<li><a href="../3_declaraci_de_variables/">3. Declaració de variables</a></li>
<li><a href="../4_instruccions/">4. Instruccions</a></li>
<li><a href="../5_funcions/">5. Funcions</a> </li>
<li><a href="../exercicis/">Exercicis</a></li>
<li><a href="../6_utilitzaci_de_cursors/">6. Utilització de cursors</a> </li>
<li><a href="../exercicis0/">Exercicis</a></li>
<li><a href="../7_missatges_i_excepcions/">7. Missatges i excepcions</a></li>
<li><a href="./">8. Triggers</a> </li>
<li><a href="../exercicis1/">Exercicis</a></li>
<li><a href="../9_creaci_daltres_objectes_basats_en_funcions/">9. Creació d'altres objectes basats en funcions</a> </li>
<li><a href="../91_operadors/">9.1 Operadors</a> <ul>
<li><a href="../exercicis2/">Exercicis</a></li>
</ul>
</li>
<li><a href="../92_operadors_de_classe/">9.2 Operadors de classe</a></li>
<li><a href="../93_funcions_dagregat/">9.3 Funcions d'agregat</a> <ul>
<li><a href="../exercicis3/">Exercicis</a></li>
</ul>
</li>
<li><a href="../exercicis_de_tot_el_tema/">Exercicis de tot el tema</a></li>
</ul>
<p><a href="../7_missatges_i_excepcions/">« Anterior</a> | <a href="../exercicis1/">Següent »</a></p>
<h1 id="8-triggers"><a name="main"></a><strong>8. Triggers</strong></h1>
<p>Un <strong>TRIGGER</strong> o <strong>disparador</strong> és un procediment que se dispara quan s’acompleix una determinada condició que afecta a la Base de Dades: quan s’actualitza una o més d’una fila d’una determinada taula. En el moment de crear el trigger especificarem una funció que s'executarà quan es produesca l'event. Aquesta funció pot estar escrita en qualsevol llenguatge de programació instal·lat, i ha de tornar un valor especial: <strong><em>trigger</em></strong>. Juguem per tant a dues bandes. Primer amb la funció que s'executarà, i quan aquesta estiga creada, el trigger pròpiament dit.</p>
<p>La sintaxi de creació del <em>trigger</em> és:</p>
<p>CREATE TRIGGER nom_trig </p>
<p>{BEFORE | AFTER} {INSERT | DELETE | UPDATE} [OR {INSERT | DELETE |UPDATE} ...]
ON nom_taula
[FOR EACH {ROW | STATEMENT}]
EXECUTE PROCEDURE nom_funció ([paràmetres]);</p>
<p>Lamentablement no tenim l’opció <strong>OR REPLACE</strong>, que ens permetria no haver d’esborrar el <em>trigger</em> en cas de voler refer-lo (cosa prou normal). Per tant, en el cas tan habitual de voler refer un <em>trigger</em>, primer l'haurem d'esborrar (<strong>DROP TRIGGER</strong>) i després tornar a fer-lo, <strong>encara que si és una modificació en la funció no cal tocar el</strong> <em>trigger</em>.</p>
<p><strong>BEFORE o AFTER</strong> indiquen quan s’ha d’activar el <em>trigger</em>: abans de produir-se l’acció d’inserir, esborrar o modificar, o després.</p>
<p><strong>INSERT</strong>, <strong>DELETE</strong> o <strong>UPDATE</strong> indiquen quina acció d’actualització de la taula provoca (o pot provocar) el <em>trigger</em>.</p>
<p>Una actualització pot afectar més d’una fila. Aleshores ens plantegem si s’ha de disparar el <em>trigger</em> per a cada actualització de cada fila, o si només una vegada (abans o després d’actualitzar). Ho podrem especificar per mig de <strong>FOR EACH ROW</strong> o <strong>FOR EACH STATEMENT</strong>. L'opció per defecte és la segona.</p>
<p>Suposem que volem activar un disparador sempre abans d’inserir sobre la taula <strong>T1</strong>, per a cada fila, per si la introducció no fóra correcta:</p>
<p>CREATE TRIGGER trigger1 BEFORE INSERT ON T1 FOR EACH ROW </p>
<p>EXECUTE PROCEDURE ...;</p>
<p>I ara que volem activar un altre després d’esborrar un conjunt de files (per exemple per a actualitzar una altra taula):</p>
<p>CREATE TRIGGER trigger2 AFTER DELETE ON T1 FOR EACH STATEMENT </p>
<p>EXECUTE PROCEDURE ...;</p>
<p>Anem a parlar ara de la funció que es crida quan es dispara el <em>trigger</em>. És una funció especial, escrita en qualsevol llenguatge definit, que com hem comentat abans ha de tornar obligatòriament un valor <strong>TRIGGER</strong>. De fet, amb la utilitat PgAdmin existeix l'objecte <strong>TRIGGER FUNCTION</strong> diferenciat de les funcions normals. Aquesta funció pot tenir paràmetres, i òbviament hauran de coincidir aquestos en la definició de la funció i en la definició del <em>trigger</em>.</p>
<p>Quan s'arriba a la funció, que nosaltres sempre la definirem en PL/pgSQL, s'han definit unes quantes variables especials. Anem a comentar-les:</p>
<ul>
<li><strong>NEW</strong>: de tipus RECORD. Conté la fila que va a inserir-se o la nova informació, si va a actualitzar-se</li>
<li><strong>OLD</strong>: de tipus RECORD. Conté la fila que va a esborrar-se o la informació vella, si va a actualitzar-se.</li>
<li><strong>TG_NAME</strong>: de tipus NAME. Conté el nom del trigger que s'ha disparat i ha cridat aquesta funció (podria ser que més d'un trigger apunte a una funció, però nosaltres no ho contemplarem)</li>
<li><strong>TG_WHEN</strong>: de tipus TEXT. Indica quan actua el trigger, BEFORE o AFTER.</li>
<li><strong>TG_LEVEL</strong>: de tipus TEXT. Indica de quina manera actua, ROW o STATEMENT.</li>
<li><strong>TG_OP</strong>: de tipus TEXT. Indica quin event ha provocat el trigger: INSERT, UPDATE o DELETE</li>
<li><strong>TG_RELID</strong>: de tipus OID. Conté l'identificador de la taula que ha provocat el trigger (podria ser més d'una).</li>
<li><strong>TG_RELNAME</strong>: de tipus TEXT. Conté el nom de la taula que ha provocat el trigger</li>
<li><strong>TG_NARGS</strong>: de tipus INTEGER. Indica el nombre de paràmetres que se li passen.</li>
<li><strong>TG_ARGV[ ]</strong>: de tipus VECTOR de TEXT. Vector que conté els paràmetres.</li>
</ul>
<p><code></code>Aquesta és una relació de variables prou extensiva. En la pràctica nosaltres només utilitzarem <strong>NEW</strong>, <strong>OLD</strong> i en tot cas <strong>TG_OP</strong>.</p>
<p>Una funció de trigger ha de tornar o bé null, o bé un RECORD amb la mateixa estructura que la fila de la taula.</p>
<p>Si un trigger de nivell de fila (<em>for each row</em>) torna un valor nul, no s'efectuaran més operacions (si és un delete, que esborra més d'una fila, si la funció torna nul ja no s'intentaran esborrar més files). En canvi si torna una cosa distinta de nul, aleshores es procedirà a l'actualització amb aquest valor. Així, per curar en salut, podem fer que l'última línia de la funció de trigger siga <strong>RETURN NEW;</strong> Açò pot ser molt útil, ja que si és una inserció o actualització podríem fins i tot modificar la fila NEW per a que agafe els valors que nosaltres volem (per exemple: <strong>NEW.sou := NEW.sou + 500</strong> si estiguérem actualitzant el sou d'un empleat).</p>
<p>Els valors tornats per una funció trigger de nivell de <strong><em>statement</em></strong> són sempre ignorats, igual que un AFTER de nivell de fila (ja és massa tard per actuar), i per tant millor posar que tornen nul.</p>
<p>Anem a veure un exemple, per impedir que es modifique el nombre d'habitants d'una localitat en més de 50000 persones (augmentant o disminuint). Només té sentit el control quan es modifique la columna <strong>poblacio</strong>. No té sentit ni en inserir ni en esborrar una fila. I ens convé abans d’actualitzar, per poder impedir-ho.</p>
<p>CREATE FUNCTION val_50000() RETURNS TRIGGER AS <span class="arithmatex">\(cos\)</span></p>
<p>BEGIN</p>
<p><code></code>IF abs(NEW.poblacio - OLD.poblacio) &gt; 50000 THEN</p>
<p><code></code>RAISE EXCEPTION 'Massa diferència. No pot ser!!';</p>
<p><code></code>END IF;</p>
<p><code></code>RETURN NEW;</p>
<p>END; <span class="arithmatex">\(cos\)</span> </p>
<p>LANGUAGE plpgsql;</p>
<p>CREATE TRIGGER tr_val_50000 BEFORE UPDATE ON POBLACIONS</p>
<p><code></code>FOR EACH ROW</p>
<p><code></code>EXECUTE PROCEDURE val_50000();</p>
<p>Podríem comprovar el funcionament del trigger actualitzant alguna fila de la taula POBLACIONS:</p>
<p>UPDATE POBLACIONS</p>
<p><code></code>SET poblacio = 1000</p>
<p><code></code>WHERE nom='Castelló de la Plana';</p>
<p>Com veieu estem intentant actualitzar la població de Castelló de la Plana a 1.000 habitants. Com que la població actual és de 173.841, hi haurà una diferència de més de 50.000 habitants, i per tant el trigger impedirà l'actualització:</p>
<p><img alt="ref1" src="8_triggers.002.png" /></p>
<p><strong>Nota</strong></p>
<p>En DBeaver veurem els triggers en la taula a la qual afecten.</p>
<p><img alt="ref2" src="8_triggers.003.png" /></p>
<p>Mirem un altre exemple: un trigger que actualitza automàticament el nombre d'instituts de la taula <strong>PROVINCIES</strong> (teniu la sentència de creació en la pregunta 0 d'aquest tema) quan s'insereix o s'esborra un institut. Primer s'haurà de mirar la província de l'institut que s'està introduint o esborrant, i després s'incrementa o decrementa el nombre d'instituts de la província:</p>
<p>CREATE OR REPLACE FUNCTION act_inst() RETURNS TRIGGER AS <span class="arithmatex">\(cos\)</span></p>
<p>DECLARE aux text;</p>
<p>BEGIN</p>
<p><code></code>IF TG_OP='INSERT'</p>
<p><code></code>THEN</p>
<p><code></code>SELECT provincia INTO aux FROM POBLACIONS,COMARQUES</p>
<p><code></code>WHERE POBLACIONS.nom_c=COMARQUES.nom_c AND</p>
<p><code></code>POBLACIONS.cod_m = NEW.cod_m;</p>
<p><code></code>UPDATE PROVINCIES</p>
<p><code></code>SET instituts = instituts + 1</p>
<p><code></code>WHERE provincia = aux;</p>
<p><code></code>ELSE</p>
<p><code></code>SELECT provincia INTO aux FROM POBLACIONS,COMARQUES</p>
<p><code></code>WHERE POBLACIONS.nom_c=COMARQUES.nom_c AND</p>
<p><code></code>POBLACIONS.cod_m = OLD.cod_m;</p>
<p><code></code>UPDATE PROVINCIES</p>
<p><code></code>SET instituts = instituts - 1</p>
<p><code></code>WHERE provincia = aux;</p>
<p><code></code>END IF;</p>
<p><code></code>RETURN NEW;</p>
<p>END; <span class="arithmatex">\(cos\)</span> </p>
<p>LANGUAGE plpgsql;</p>
<p>CREATE TRIGGER tr_act_inst AFTER INSERT OR DELETE ON INSTITUTS</p>
<p><code></code>FOR EACH ROW</p>
<p><code></code>EXECUTE PROCEDURE act_inst();</p>
<p>Podrem comprovar-ho, per exemple, introduint un nou registre. Abans de l'actualització, el contingut de la taula PROVINCIES és:</p>
<p><img alt="ref3" src="8_triggers.004.png" /></p>
<p>Inserim ara el nou institut, corresponent a Castelló (el codi del municipi és 12040)</p>
<p>INSERT INTO INSTITUTS VALUES</p>
<p><code></code>('12004299','IES MARJALERIA','CAMÍ LA PLANA','S/N',12003,12040);</p>
<p>El contingut de la taula PROVINCIES és ara:</p>
<p><img alt="ref4" src="8_triggers.005.png" /></p>
<p>Un últim exemple per a veure el de <strong>FOR EACH STATEMENT</strong>. Intentarem fer un trigger per a que actualitze la població de les províncies. Ara anem a plantejar-lo de manera que calcule una altra vegada el total de les poblacions. Per tant, segurament és millor calcular-ho quantes menys vegades millor; és a dir, si es fan unes quantes actualitzacions de les poblacions, doncs calcular al final de totes elles (i no després de cadascuna).</p>
<p>CREATE OR REPLACE FUNCTION act_pobl() RETURNS TRIGGER AS <span class="arithmatex">\(cos\)</span></p>
<p>BEGIN</p>
<p><code></code>UPDATE PROVINCIES</p>
<p><code></code>SET habitants = (SELECT SUM(poblacio)</p>
<p><code></code>FROM COMARQUES,POBLACIONS</p>
<p><code></code>WHERE COMARQUES.nom_c=POBLACIONS.nom_c and</p>
<p><code></code>provincia=PROVINCIES.provincia);</p>
<p><code></code>RETURN NEW;</p>
<p>END; <span class="arithmatex">\(cos\)</span></p>
<p>LANGUAGE plpgsql;</p>
<p>CREATE TRIGGER tr_act_pobl AFTER INSERT OR DELETE OR UPDATE</p>
<p><code></code>ON POBLACIONS FOR EACH STATEMENT</p>
<p><code></code>EXECUTE PROCEDURE act_pobl();</p>
<p>Per a poder comprovar el resultat del trigger anem a fer una operació d'actualització. Per exemple anem a incrementar cada població de la comarca de l'Alcalatén en 10.000 habitants (recordeu que ja tenim un trigger que impedeix augmentar en més de 50.000).</p>
<p>UPDATE POBLACIONS</p>
<p><code></code>SET poblacio = poblacio + 10000</p>
<p><code></code>WHERE nom_c = 'Alcalatén';</p>
<p>Com que la comarca té 9 pobles, la població de la província de Castelló haurà augmentat en 90.000 habitants:</p>
<p><img alt="ref5" src="8_triggers.006.png" /></p>
<p>No oblidem executar l'operació de restar 10.000 habitants als pobles de la comarca de l'Alcalatén, i llevar l'institut de la Marjaleria, per deixar les coses com estaven (encara que només són dades de prova molt desactualitzades).</p>
<p>UPDATE POBLACIONS</p>
<p><code></code>SET poblacio = poblacio - 10000</p>
<p><code></code>WHERE nom_c = 'Alcalatén';</p>
<p>DELETE FROM INSTITUTS</p>
<p><code></code>WHERE codi = '12004299';</p>
<p>Per esborrar un trigger, utilitzarem la instrucció <strong>DROP TRIGGER</strong>:</p>
<p>DROP TRIGGER nom_trigger ON nom_taula;</p>
<p>La modificació d'un trigger (<strong>ALTER TRIGGER)</strong> només permet canviar el nom d'aquest trigger.</p>
<p>Pot ser molt útil en ocasions desactivar un <em>trigger</em>, de manera que no tinga efecte durant una temporada, i tornar a activar-lo més avant. Està clar que sempre podríem esborrar-lo i tornar a crear-lo quan faça falta, però serà més còmoda la desactivació. Aquesta operació es fa en l'<strong>ALTER TABLE</strong> de la taula a la qual implica el <em>trigger</em>.</p>
<p>ALTER TABLE nom_taula [ENABLE | DISABLE] TRIGGER [nom_trigger | ALL | USER ];</p>
<p>Com es pot comprovar, la sentència permet activar o desactivar un <em>trigger</em> en concret, o tots els <em>triggers</em> (caldrà tenir privilegis de superusuari, ja que açò inclouria els <em>triggers</em> implicits que fan acomplir les restriccions d'integritat, i això només ho podria fer un superusuari), o els <em>triggers</em> d'usuari, que són els que no són per implementar les claus externes.</p>
<p><a href="../7_missatges_i_excepcions/">« Anterior</a> | <a href="../exercicis1/">Següent »</a></p>
<p>Llicenciat sota la <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Llicència Creative Commons Reconeixement NoComercial CompartirIgual 3.0</a>
<strong>Created with an evaluation copy of Aspose.Words. To discover the full versions of our APIs please visit: https://products.aspose.com/words/</strong></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.path", "navigation.indexes", "toc.integrate", "search.highlight", "content.code.annotation", "content.code.copy"], "search": "../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
    
  </body>
</html>